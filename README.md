# Malware-Analysis

## Objective

The Malware Analysis project aimed to analyze and dissect malware samples, uncovering their code structure and behavioral pattern through Static & Dynamic Analysis.

## Skills Learned

- Acquired proficiency in executing malware within a controlled environment to observe real-time behavior and assess potential impact.
- Developed skills in reverse engineering to dissect malware, unraveling its code structure, encryption, and evasion techniques.
- Gained knowledge on the analysis of malware-generated network traffic to identify communication patterns, command-and-control servers, and data exfiltration methods.
- Learned how to use various malware analysis tools.

## Tools Used

- VMs : RemNux & FlareVM for controlled malware analysis.
- Virustotal : to check IP's, files, domains for maliciousness.
- PeStudio : to get info on strings inside malware files & much more
- INetSim : to spoof/simulate Networking services such DNS, HTTP, HTTPS.
- Procmon : to monitor & analyse proccesses for suspicious behaviour.
- Wireshark : to intercept & analyse malicious network traffic.
- Any.Run : Additional dynamic sandboxing.
- Zeus banking Trojan (malware)

## Steps

**We will be performing our malware analysis on Zeus Banking Trojan**

**1. General Malware Info :**

**Filename: invoice_2318362983713_823931342io.pdf.exe**

**Hashes:**
* **md5: EA039A854D20D7734C5ADD48F1A51C34**
* **sha1: 9615DCA4C0E46B8A39DE5428AF7DB060399230B2**
* **sha256: 69E966E730557FDE8FD84317CDEF1ECE00A8BB3470C0B58F3231E170168AF169**

**Other names of this malware**

![4](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/9b963aa3-0c8e-46ed-84cb-84f2f9a11e6d)

**Static Analysis**

**Virustotal**

**2. We will start our static investigation by uploading malware file on virustotal which tells us that 62/70 vendors flagged this file as malicious, which confirms this is a malware.**

![1](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/064d03be-f708-48e1-829e-acc99bf1db19)

**3. We also see in Relations pane that this malware file tries to contact fpdownload.macromedia.com URL.**

![2](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/3d35d12d-9c3d-444d-ac5a-ba902b6799d1)

**4. This Malware tries to show itself as a pdf file**

![3](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/acb25d95-3c48-4b8a-9a0b-04bbeaad3304)

**PeStudio**

**5. In PeStudio, we see that the first byte of this file starts with MZ which is a indicator of Executable file (.exe).**

![9 pestudio](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/8a190ab6-04e5-4533-8c67-8cb2b4e66bbd)

**6. In Sections tab, we can see that the size difference between raw-size & virtual size is not that much, which means this file is not compressed.**

![5 PeStudio](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/b834731a-04b4-4cd7-aa37-4ca24e604b80)

**7. In Libraries tab, we see that this file includes 3 Libraries of Windows API : KERNEL32.dll, SHLWAPI.dll, USER32.dll**

![8 PeStudio libraries used](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/b9c9b2f2-2a5e-412c-a721-7de061773575)

**8. In Strings tab, we find this file also has functions of those 3 libraries, which might be used to make API calls.**

![7 PeStudio](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/4fe9cd49-b75b-4917-8130-10d64207b00a)

**9. Futher Analysis reveals more of this Suspicious API call functions.**

![6 PeStudio](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/00feb3e3-3d5a-4a2e-9626-259768ddf2e6)

**Dynamic Analysis**

**10. Now we will start with dynamic analysis. Before executing malware we will first start Procmon to monitor all processes, Wireshark to analyse network traffic, INetSim to spoof network services.**

![9 INetSim](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/dc79bb09-2020-4182-97f9-ab450cb12eb2)
![10 INetSim](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/12ce6493-64a7-4233-9998-6abaea861cea)


**11. Now as soon as we execute the malware we can see that it tries to install Adobe Flash player & deletes the binary.**

![11](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/20582db1-f55c-443a-b5ac-131d17814c28)

**Procmon**

**12. In Procmon, Process Tree reveals that the invoice malware creates 2 childern processes called InstallFlashPlayer.exe & cmd.exe**

**13. We can assume that this InstallFlashPlayer.exe is trying to download the Flash player which we saw earlier.**

![12 ProcMon](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/2d39c14e-55d4-4d8b-ab25-111a75fb2882)

**14. conhost.exe is a background command prompt which is used to execute commands not visible to user. We see that this conhost.exe is executing some malicious command in background.**

![13 ProcMon](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/27527150-b17f-4e45-a251-ac96e6da3cd9)

**15. Now we will filter the results to only include invoice malware by making filter of Process Name : invoice & PATH : %TEMP% to see if malware has created something in TEMP folder**

![15 ProcMon](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/0f360835-673b-41b6-83c6-a9a6b9b38611)

**16. We find out by filtering that malware has created 2 files msimg32.ddl and InstallFlashPlayer.exe in %TEMP% folder.**

![14 ProcMon](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/bcf2cdee-4847-4150-9073-70a0aa70bd89)

**17. Now if we upload both files in Virustotal, we find out that FlashPlayer file is not flagged malicious but msimg32.dll is flagged malicious by 59/70 vendors.**

![20 Virustotal](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/70e43542-49dd-48e2-bdfb-7343467116e3)

**18. Now we will see if this malware has created any Registry entries by creating filter of Process Name : invoice & Operation : RegSetValue.**

![16 ProcMon](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/0b33e36d-b072-425d-99ab-7e4fd4b57a68)

**19. By filtering we can see that invoice has created registry value by name Google Update.**

![21 Procmon](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/5d629adc-6dd5-4d2e-a9e1-1991b0e11d5e)

**20. In Procmon Process Tree, we can see that the same google update.exe is running, which might indicate the virus has reinstalled itself as google update or it has integrated itself with google update process for persistance.**

**21. We can also deduce that because the malware has found persistance in google update that is the reason why it has deleted its binary to reduce suspicion.**

![22 Procmon](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/a8c2d876-8c69-4379-8e35-4398fb9d8828)

**Wireshark**

**22. Now if we see in Wireshark, we can find that some conversations are happening in HTTP which is very suspicious.**

**23. And if we have follow stream of that HTTP, we can clearly see malware trying to contact the same URL we found in virustotal i.e. fpdownlaod.macromedia.com.**

![17 Wireshark](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/2673513d-8ebe-45a1-b339-3f62189ca433)

**24. Finally if we try to find information on fpdownload.macromedia.com, we can find Any.Run sandbox which shows similar behaviour activities as we experienced when we executed the binary.**

![18 Any Run](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/077e856e-75be-434e-a285-7da4eeadebb5)
![19 Any run](https://github.com/laaaaaarry/Malware-Analysis/assets/125237930/fac794e2-730a-4ee7-96a2-aaefa42c0ed8)

## Documentation 


* Filename : invoice_2318362983713_823931342io.pdf.exe
* Hashes :
    * MD5 - EA039A854D20D7734C5ADD48F1A51C34
    * SHA1 - 9615DCA4C0E46B8A39DE5428AF7DB060399230B2
    * SHA256 - 69E966E730557FDE8FD84317CDEF1ECE00A8BB3470C0B58F3231E170168AF169
* 62 of 70 vendors flagged invoice file malicious in virustotal
* Malware is trying to present itself as pdf file by masking extension as .pdf
* Malware file is actually .exe (executable) because the first byte of file is MZ which is a indicator of .exe file
* The malware file is not compressed
* Malware file consists of 3 libraries : KERNEL32.dll, USER32.dll, SHLWAPI.dll
* Malware file also includes function calls for this libraries
* When we execute malware, flash player is installed & malware binary is deleted
* Malware creates 2 child processes : InstallFlashPlayer.exe & cmd.exe
* First process tries to download flash player & second process executes suspicious command in background
* Malware has created 2 files msimg.dll & flashplayer.exe in %TEMP% folder, of which msimg.dll is malicious
* Malware has created googleupdate.exe for persistance
* Malware tries to contact fpdownload.macromedia.com URL
* Same behaviour of file can be seen in Any.Run sandbox

